<!doctype html>
<html>

    <head>
        <meta charset=utf-8>
        <meta name=description content="">
        <meta name=viewport content="width=device-width, initial-scale=1, maximum-scale=1">
        <title>iNote</title>
        <link href='http://fonts.googleapis.com/css?family=Cousine' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Roboto+Condensed' rel='stylesheet' type='text/css'>

        <link rel=stylesheet href="css/inote.css">
        <link rel=stylesheet href="css/cell.css">


        <!-- jQuery -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script src="libs/colResizable-1.3.min.js"></script>
        <!--<script src="//code.jquery.com/ui/1.10.3/jquery-ui.js"></script>-->



        <!-- codemirror begin-->

            <link rel="stylesheet" type="text/css" href="libs/codemirror-3.0/lib/codemirror.css"/>
            <script type="text/javascript" src="libs/codemirror-3.0/lib/codemirror.js"></script>

            <!-- autosize  -->
            <link rel=stylesheet href="css/mycodemirror.css">


            <!-- autocompletion -->

            <link rel="stylesheet" type="text/css" href="libs/codemirror-3.0/addon/hint/show-hint.css"/>
            <script type="text/javascript" src="libs/codemirror-3.0/addon/hint/show-hint.js"></script>
            <script type="text/javascript" src="libs/codemirror-3.0/addon/hint/javascript-hint.js"></script>

            <!--comments-->
            <script src="libs/codemirror-3.0/addon/comment/comment.js"></script>

        <!-- modes -->

            <script src="libs/codemirror-3.0/mode/xml/xml.js"></script>
            <script src="libs/codemirror-3.0/mode/javascript/javascript.js"></script>
            <script src="libs/codemirror-3.0/mode/css/css.js"></script>
            <script src="libs/codemirror-3.0/mode/htmlmixed/htmlmixed.js"></script>
            <script src="libs/codemirror-3.0/mode/coffeescript/coffeescript.js"></script>


            <!-- themes -->

        <link rel="stylesheet" href="libs/codemirror-3.0/theme/neat.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/elegant.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/erlang-dark.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/night.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/monokai.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/cobalt.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/eclipse.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/rubyblue.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/lesser-dark.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/xq-dark.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/xq-light.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/ambiance.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/blackboard.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/vibrant-ink.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/solarized.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/twilight.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/midnight.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/3024-day.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/3024-night.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/base16-light.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/base16-dark.css">
        <link rel="stylesheet" href="libs/codemirror-3.0/theme/tomorrow-night-eighties.css">
        
        


        <!-- addons -->
        <!--formatting is from v3.0-->
        <script src="libs/codemirror-3.0/addon/edit/formatting.js"></script>

        <script src="libs/codemirror-3.0/addon/edit/matchbrackets.js"></script>
        <script src="libs/codemirror-3.0/addon/edit/closetag.js"></script>

        <!-- folding -->
        <script src="libs/codemirror-3.0/addon/fold/foldcode.js"></script>
        <script src="libs/codemirror-3.0/addon/fold/foldgutter.js"></script>
        <script src="libs/codemirror-3.0/addon/fold/brace-fold.js"></script>
        <script src="libs/codemirror-3.0/addon/fold/xml-fold.js"></script>
        <script src="libs/codemirror-3.0/addon/fold/indent-fold.js"></script>

        <!--<script src="libs/codemirror-3.0/lib/util/collapserange.js"></script>-->

        <!--Search repalce -->
        <script src="libs/codemirror-3.0/addon/dialog/dialog.js"></script>
        <link rel="stylesheet" href="libs/codemirror-3.0/addon/dialog/dialog.css">
        <script src="libs/codemirror-3.0/addon/search/searchcursor.js"></script>
        <script src="libs/codemirror-3.0/addon/search/search.js"></script>

        <!-- codemirror end-->

        <!-- additional functionality -->
        <script type="text/javascript" src="libs/coffee-script.js"></script>
        <script type="text/javascript" src="libs/json2.min.js"></script>
        <script type="text/javascript" src="libs/showdown.js"></script>


        <script type="text/javascript" src="js/cdmirror.js"></script>
        <script type="text/javascript" src="js/cell.js"></script>
        <script type="text/javascript" src="js/inote.js"></script>
        <!--<script type="text/javascript" src="js/debug.js"></script>-->
        <script type="text/javascript" src="js/notebookstorage.js"></script>
        <script type="text/javascript">




       function selectTheme() {
            var input = document.getElementById("selectTheme_button");
            var theme = input.options[input.selectedIndex].innerHTML;
            inote.setTheme(theme);
            saveNotebookLater();

        }




        var storage=new NoteBookStorage();


        var saveNotebookTimeout;
        function saveNotebookLater(){
            clearTimeout(saveNotebookTimeout);
            ($("#autoSave").is(":checked")) ? saveNotebookTimeout=setTimeout(saveNotebook,2000) : null;
            $("#saveIndicator").text("");
        }


        function saveNotebook()
        {
            var notebookName=$("#notebookName").val();
            var notebookOwner=$(".notebookOwner").text();
            var notebookAaccess=$("#notebookAccess").val();

            xmlText=inote.getXmlText(notebookName);
            //console.log(xmlText);
            console.log("saveNotebook");

            //localStorage.setItem("inote_"+bookName, xmlText);


            storage.put(notebookAaccess,notebookName, xmlText, function(d){$("#saveIndicator").text("(saved)");});

//            $("#btnSave").css("color","silver");
        }

        function openNotebook(notebookOwner , notebookAccess, notebookName)
        {
            clearAndInit();
            if (!notebookName) return;

            $(".notebookOwner").text(notebookOwner);
            $("#notebookName").val(notebookName);
            $("#notebookAccess").val(notebookAccess);

            storage.get(notebookOwner, notebookName, restoreNotebookFromXml);
        }

        function restoreNotebookFromXml(xmlText)
        {
            if (! xmlText)
            {
                return;
            }
            inote.clear();
            inote.setXmlText(xmlText);

            var notebook = $(xmlText);
            var themeName=notebook.attr("theme");
            $("#selectTheme_button").val(themeName);



            if ($(".cell").length==0)
                inote.init();
        }

        function getNotebookAccessFromUrl()
        {
            var notebook_access="";
            try {
                notebook_access=location.href.match(/notebook_access=([^&]*)/)[1];
            } catch(e){}
            notebook_access=decodeURIComponent(notebook_access);
            return notebook_access;
        }



        function getNotebookNameFromUrl()
        {
            var notebook_name="";
            try {
                notebook_name=location.href.match(/notebook_name=([^&]*)/)[1];
            } catch(e){}
            notebook_name=decodeURIComponent(notebook_name);
            return notebook_name;
        }
        function getNotebookOwnerFromUrl()
        {
            var notebook_owner="";
            try {
                notebook_owner=location.href.match(/notebook_owner=([^&]*)/)[1];
            } catch(e){}
            notebook_owner=decodeURIComponent(notebook_owner);
            return notebook_owner;
        }

        function clearAndInit(){
            inote.clear();
            inote.init();
        }

        var inote;
        $(function(){
            $(".loginHolder").load("/getloginlink");
            inote=new iNote($("#page"));
//            inote=new iNote($(document.body));
            openNotebook(getNotebookOwnerFromUrl(), getNotebookAccessFromUrl(), getNotebookNameFromUrl());

            //handlers
            $('body').keydown(function(event){
                if (event.ctrlKey && event.keyCode==83) //Ctrl-S
                {
                    saveNotebook();
                    return false;
                }
            })
            //$("#btnClear").click(clearAndInit);
            $("#btnSave").click(saveNotebook);
//            $("#btnOpen").click(function(){
//                openNotebook($(".notebookOwner").text(), $("#notebookAccess").val(),  $("#notebookName").val() );
//            });
        });



        </script>
    </head>
    <body>


        <div id="divHeader" class="header lr_padded">
            <!--<div id="divMenu" >-->
                <table style="width: 100%">
                    <tr>
                        <td style="width:100%">
                            <input type="text" id="notebookName" class="notebookName" value="New notebook"/>
                        </td>
                        <td style="text-align: right; white-space: nowrap">
                            <span class="loginHolder"></span>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:100%">
                            <a href="index.html"  class="toolButton">Home</a>
                            <!--<span id="btnClear" class="toolButton" >clear</span>-->
                            <span id="btnSave" class="toolButton" >save</span>
                            <span class="toolButton"><input id="autoSave" type="checkbox" style="vertical-align: text-top"><label for="autoSave"  >autosave</label></span>
                            <!--<span id="btnOpen" class="toolButton" >restore</span>-->
                            <select id="notebookAccess" title="Access" class="selectButton">
                                <option value="public">public</option>
                                <option value="private">private</option>
                            </select>
                            <select class="selectButton" onchange="selectTheme()" id="selectTheme_button">
                                <option selected>default</option>
                                <option>3024-day</option>
                                <option>3024-night</option>
                                <option>ambiance</option>
                                <option>base16-dark</option>
                                <option>base16-light</option>
                                <option>blackboard</option>
                                <option>cobalt</option>
                                <option>eclipse</option>
                                <option>elegant</option>
                                <option>erlang-dark</option>
                                <option>lesser-dark</option>
                                <option>midnight</option>
                                <option>monokai</option>
                                <option>neat</option>
                                <option>night</option>
                                <option>rubyblue</option>
                                <option>solarized dark</option>
                                <option>solarized light</option>
                                <option>tomorrow-night-eighties</option>
                                <option>twilight</option>
                                <option>vibrant-ink</option>
                                <option>xq-dark</option>
                                <option>xq-light</option>
                            </select>

                        </td>
                       <td style="text-align: right; white-space: nowrap">

                            Author:
                           <span class="notebookOwner" title="Notebook creator"></span>
                           <span id="saveIndicator"></span>

                        </td>
                    </tr>

                </table>
            <!--</div>-->

            <!--<div >-->
                <!--<table cellspacing="0" cellpadding="0" style="width: 100%">-->

                <!--</table>-->
            <!--</div>-->
        </div>


        <div id="page" class="page"></div>



    </body>
</html>
